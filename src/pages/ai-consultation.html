<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìœ¤ì°½ íŠ¸ë ˆì´ë„ˆì˜ PT Manager</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <script src="../js/dark-mode.js"></script>
    <script src="../../config/config.js"></script>
    <script src="ai-system-prompt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 300px);
            min-height: 400px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            border: 1px solid var(--border-light);
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: var(--font-size-sm);
        }

        .chat-avatar.ai {
            background-color: var(--primary);
            color: white;
        }

        .chat-avatar.user {
            background-color: var(--text-secondary);
            color: white;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-message.ai .chat-bubble {
            background-color: var(--bg-gray);
            color: var(--text-primary);
        }

        .chat-message.user .chat-bubble {
            background-color: var(--primary);
            color: white;
        }

        .chat-input-container {
            background-color: var(--bg-white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--border-gray);
            border-radius: var(--radius);
            padding: 0.75rem;
            font-size: var(--font-size-base);
            resize: none;
            min-height: 44px;
            max-height: 150px;
            font-family: inherit;
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .chat-send-btn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .chat-send-btn:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .chat-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .member-info-banner {
            background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .member-info-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .member-info-text h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: 0.25rem;
        }

        .member-info-text p {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="darkModeToggle" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <div class="sidebar-title">
                  <div class="sidebar-title-main">PT Manager</div>
                  <div class="sidebar-title-sub">ì´ìœ¤ì°½ íŠ¸ë ˆì´ë„ˆì˜</div>
                  <div class="sidebar-title-sub">ë§ì¶¤í˜• íšŒì› ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    ëŒ€ì‹œë³´ë“œ
                </a>
                <a href="main.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    íŠ¸ë ˆì´ë„ˆ ì†Œê°œ
                </a>
                <a href="members.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    íšŒì› ê´€ë¦¬
                </a>
                <a href="members2.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="10" width="18" height="12" rx="2"></rect>
                        <path d="M7 10V6a5 5 0 0 1 10 0v4"></path>
                        <line x1="9" y1="16" x2="9" y2="16"></line>
                        <line x1="15" y1="16" x2="15" y2="16"></line>
                    </svg>
                    íšŒì› ê´€ë¦¬2
                </a>
                <a href="workout-entry.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    ìš´ë™ì¼ì§€ ì‘ì„±
                </a>
                <a href="workout-entry2.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    ìš´ë™ì¼ì§€ ì‘ì„±2
                </a>
                <a href="workout-history.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    ìš´ë™ì¼ì§€ ì¡°íšŒ
                </a>
                <a href="ai-consultation.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    AI ìƒë‹´
                </a>
            </nav>

            <div class="sidebar-footer">
              Â© 2025 ì´ìœ¤ì°½ íŠ¸ë ˆì´ë„ˆì˜ PT Manager
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">AI ìƒë‹´</h1>
                    <p class="page-description">íšŒì› ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIì™€ ìƒë‹´í•˜ì„¸ìš”</p>
                </div>

                <!-- Member Selection -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">íšŒì› ì„ íƒ <span class="required">*</span></label>
                        <select id="memberSelect" class="form-select">
                            <option value="">íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <!-- Member Info Banner -->
                <div id="memberInfoBanner" style="display: none;">
                    <div class="member-info-banner">
                        <div class="member-info-content">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <div class="member-info-text">
                                <h3 id="memberName">-</h3>
                                <p id="memberDetail">íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                        <button id="changeMemberBtn" class="btn btn-secondary" style="background-color: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                            íšŒì› ë³€ê²½
                        </button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p>íšŒì›ì„ ì„ íƒí•˜ë©´</p>
                            <p>AI ìƒë‹´ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <textarea
                            id="chatInput"
                            class="chat-input"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="1"
                            disabled></textarea>
                        <button id="sendBtn" class="chat-send-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Config
        const SUPABASE_URL = window.APP_CONFIG?.SUPABASE_URL;
        const SUPABASE_ANON_KEY = window.APP_CONFIG?.SUPABASE_ANON_KEY;
        const OPENAI_API_KEY = window.APP_CONFIG?.OPENAI_API_KEY;

        let supabase = null;
        let selectedMember = null;
        let conversationHistory = [];

        // Initialize Supabase
        if (SUPABASE_URL && SUPABASE_ANON_KEY &&
            SUPABASE_URL !== 'YOUR_SUPABASE_URL' &&
            SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            loadMembers();
        } else {
            console.warn('Supabase configuration required');
        }

        // DOM elements
        const memberSelect = document.getElementById('memberSelect');
        const memberInfoBanner = document.getElementById('memberInfoBanner');
        const memberName = document.getElementById('memberName');
        const memberDetail = document.getElementById('memberDetail');
        const changeMemberBtn = document.getElementById('changeMemberBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Load members
        async function loadMembers() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('members')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) throw error;

                memberSelect.innerHTML = '<option value="">íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                data.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    memberSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        // Member selection
        memberSelect.addEventListener('change', async function() {
            const memberId = this.value;
            if (!memberId) return;

            try {
                const { data, error } = await supabase
                    .from('members')
                    .select('*')
                    .eq('id', memberId)
                    .single();

                if (error) throw error;

                selectedMember = data;
                showMemberInfo(data);
                initializeChat();
            } catch (error) {
                console.error('Error loading member:', error);
                alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Show member info
        function showMemberInfo(member) {
            memberName.textContent = member.name;

            let details = [];
            if (member.age) details.push(`${member.age}ì„¸`);
            if (member.gender === 'male') details.push('ë‚¨ì„±');
            if (member.gender === 'female') details.push('ì—¬ì„±');
            if (member.goal) details.push(member.goal);

            memberDetail.textContent = details.join(' Â· ') || 'íšŒì› ì •ë³´';

            memberInfoBanner.style.display = 'block';
            memberSelect.parentElement.parentElement.style.display = 'none';
        }

        // Change member
        changeMemberBtn.addEventListener('click', () => {
            memberInfoBanner.style.display = 'none';
            memberSelect.parentElement.parentElement.style.display = 'block';
            memberSelect.value = '';
            selectedMember = null;
            conversationHistory = [];
            chatMessages.innerHTML = `
                <div class="chat-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>íšŒì›ì„ ì„ íƒí•˜ë©´</p>
                    <p>AI ìƒë‹´ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            `;
            chatInput.disabled = true;
            sendBtn.disabled = true;
        });

        // Initialize chat
        function initializeChat() {
            conversationHistory = [];
            chatMessages.innerHTML = '';
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();

            // Add welcome message
            addMessage('ai', `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì´ìœ¤ì°½ íŠ¸ë ˆì´ë„ˆì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ ì…ë‹ˆë‹¤. ${selectedMember.name}ë‹˜ì˜ ìš´ë™ì¼ì§€ì™€ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì ì´ë‚˜ ìƒë‹´í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ë§ì”€í•´ì£¼ì„¸ìš”.`);
        }

        // Add message to chat
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = `chat-avatar ${role}`;
            avatar.textContent = role === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.id = 'typing-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar ai';
            avatar.textContent = 'ğŸ¤–';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingIndicator);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || !selectedMember) return;

            // Add user message
            addMessage('user', message);
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            // Show typing
            showTyping();

            try {
                // Get member context
                const memberContext = await getMemberContext();

                // Call OpenAI API
                const response = await callOpenAI(message, memberContext);

                // Remove typing and add AI response
                removeTyping();
                addMessage('ai', response);

            } catch (error) {
                console.error('Error:', error);
                removeTyping();
                addMessage('ai', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // Get member context
        async function getMemberContext() {
            let context = `# íšŒì› ê¸°ë³¸ ì •ë³´\n`;
            context += `ì´ë¦„: ${selectedMember.name}\n`;
            if (selectedMember.age) context += `ë‚˜ì´: ${selectedMember.age}ì„¸\n`;
            if (selectedMember.gender) context += `ì„±ë³„: ${selectedMember.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}\n`;

            // ì²´ì„±ë¶„ ì •ë³´
            if (selectedMember.height || selectedMember.weight || selectedMember.body_fat_percentage) {
                context += `\n## ì²´ì„±ë¶„ ì •ë³´\n`;
                if (selectedMember.height) context += `í‚¤: ${selectedMember.height}cm\n`;
                if (selectedMember.weight) context += `ì²´ì¤‘: ${selectedMember.weight}kg\n`;
                if (selectedMember.body_fat_percentage) context += `ì²´ì§€ë°©ë¥ : ${selectedMember.body_fat_percentage}%\n`;
                if (selectedMember.body_fat_mass) context += `ì²´ì§€ë°©ëŸ‰: ${selectedMember.body_fat_mass}kg\n`;
                if (selectedMember.skeletal_muscle_mass) context += `ê³¨ê²©ê·¼ëŸ‰: ${selectedMember.skeletal_muscle_mass}kg\n`;
                if (selectedMember.basal_metabolic_rate) context += `ê¸°ì´ˆëŒ€ì‚¬ëŸ‰: ${selectedMember.basal_metabolic_rate}kcal\n`;
            }

            // ìš´ë™ ëª©í‘œ
            if (selectedMember.goal) {
                context += `\n## ìš´ë™ ëª©í‘œ\n${selectedMember.goal}\n`;
            }

            // íŠ¹ì´ì‚¬í•­ (ë§¤ìš° ì¤‘ìš”!)
            if (selectedMember.notes) {
                context += `\n## âš ï¸ íŠ¹ì´ì‚¬í•­ (ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•¨)\n${selectedMember.notes}\n`;
            }

            // Get detailed workout logs with exercises
            try {
                const { data: logs, error: logsError } = await supabase
                    .from('workout_logs')
                    .select('id, log_date, status_check, comment')
                    .eq('member_id', selectedMember.id)
                    .order('log_date', { ascending: false })
                    .limit(10);

                if (!logsError && logs && logs.length > 0) {
                    context += `\n## ìµœê·¼ ìš´ë™ì¼ì§€ (ìµœê·¼ 10ê°œ)\n`;

                    for (const log of logs) {
                        context += `\n### ${log.log_date}\n`;

                        if (log.status_check) {
                            context += `ì»¨ë””ì…˜/íŠ¹ì´ì‚¬í•­: ${log.status_check}\n`;
                        }

                        // Get exercises for this workout log
                        const { data: exercises, error: exError } = await supabase
                            .from('exercises')
                            .select('exercise_name, exercise_order, exercise_sets(*)')
                            .eq('workout_log_id', log.id)
                            .order('exercise_order');

                        if (!exError && exercises && exercises.length > 0) {
                            context += `ìš´ë™ ë‚´ì—­:\n`;
                            exercises.forEach(exercise => {
                                context += `  ${exercise.exercise_order}. ${exercise.exercise_name}\n`;
                                if (exercise.exercise_sets && exercise.exercise_sets.length > 0) {
                                    const sortedSets = exercise.exercise_sets.sort((a, b) => a.set_number - b.set_number);
                                    sortedSets.forEach(set => {
                                        context += `     ${set.set_number}ì„¸íŠ¸: ${set.weight}kg x ${set.reps}íšŒ\n`;
                                    });
                                }
                            });
                        }

                        if (log.comment) {
                            context += `ì½”ë©˜íŠ¸: ${log.comment}\n`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading workout logs:', error);
            }

            return context;
        }

        // Call OpenAI API
        async function callOpenAI(message, memberContext) {
            if (!OPENAI_API_KEY || OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY') {
                return 'OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.js íŒŒì¼ì—ì„œ OPENAI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.';
            }

            const systemPrompt = `${window.AI_SYSTEM_RULES}

# í˜„ì¬ ìƒë‹´ ì¤‘ì¸ íšŒì› ë°ì´í„°

${memberContext}

# ì¤‘ìš” ì§€ì¹¨ (ë°˜ë“œì‹œ ì¤€ìˆ˜)
- ë°˜ë“œì‹œ "${selectedMember.name}ë‹˜ì˜ ì •ë³´ì™€ ìš´ë™ì¼ì§€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¸ ê²°ê³¼," ë¡œ ë‹µë³€ì„ ì‹œì‘í•˜ì„¸ìš”
- ì œê³µëœ ë°ì´í„°ì— ì—†ëŠ” ë‚´ìš©ì€ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”
- ëª¨ë“  ì¡°ì–¸ì€ ìš´ë™ìƒë¦¬í•™/ìŠ¤í¬ì¸ ì˜í•™ í•™ìˆ  ìë£Œ ê¸°ë°˜ìœ¼ë¡œ í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”

## íŠ¹ì´ì‚¬í•­ í™œìš© (ìµœìš°ì„  ê³ ë ¤!)
- íšŒì›ì˜ "íŠ¹ì´ì‚¬í•­" ë˜ëŠ” "notes" í•„ë“œê°€ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ë‹µë³€ì—ì„œ ë¨¼ì € ì–¸ê¸‰í•˜ì„¸ìš”
- í˜•ì‹: "íšŒì›ë‹˜ì˜ [íŠ¹ì´ì‚¬í•­ ë‚´ìš©]ì„ ê³ ë ¤í•˜ë©´, ..."
- íŠ¹ì´ì‚¬í•­ì— ê¸°ë°˜í•œ êµ¬ì²´ì ì¸ ìš´ë™ ì¶”ì²œ, ì£¼ì˜ì‚¬í•­, í”¼í•´ì•¼ í•  ë™ì‘ì„ ëª…ì‹œí•˜ì„¸ìš”

## ìš´ë™ì¼ì§€ ì½”ë©˜íŠ¸ í™œìš©
- ìš´ë™ì¼ì§€ì˜ "ì½”ë©˜íŠ¸" í•„ë“œë¥¼ ì£¼ì˜ ê¹Šê²Œ ë¶„ì„í•˜ì„¸ìš” (íŠ¸ë ˆì´ë„ˆì˜ í”¼ë“œë°± í¬í•¨)
- ìš´ë™ì¼ì§€ì˜ "ì»¨ë””ì…˜/íŠ¹ì´ì‚¬í•­" í•„ë“œì—ì„œ ë°˜ë³µë˜ëŠ” íŒ¨í„´ì´ë‚˜ ë¬¸ì œì ì„ íŒŒì•…í•˜ì„¸ìš”
- ì½”ë©˜íŠ¸ì—ì„œ ì–¸ê¸‰ëœ ê°œì„ ì‚¬í•­ì´ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ë‹µë³€ì— ë°˜ì˜í•˜ì„¸ìš”

## ìš´ë™ ì¶”ì²œ ì‹œ í•„ìˆ˜ í¬í•¨ ì‚¬í•­
- êµ¬ì²´ì ì¸ ìš´ë™ëª… 2-3ê°€ì§€
- ê° ìš´ë™ì˜ ëª©ì  (ì™œ ì´ ìš´ë™ì´ í•„ìš”í•œì§€)
- êµ¬ì²´ì ì¸ ì£¼ì˜ì‚¬í•­ (ë¬´ê²Œ, ì„¸íŠ¸/íšŸìˆ˜, ìì„¸ í¬ì¸íŠ¸, ì¢Œìš° ë°¸ëŸ°ìŠ¤ ë“±)
- í”¼í•´ì•¼ í•  ìš´ë™ì´ë‚˜ ë™ì‘ (íŠ¹ì´ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°)

- ë‹µë³€ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì†”ì§í•˜ê²Œ "ë‹µë³€í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì…ë‹ˆë‹¤"ë¼ê³  í•˜ì„¸ìš”`;

            const messages = [
                {
                    role: 'system',
                    content: systemPrompt
                },
                ...conversationHistory,
                { role: 'user', content: message }
            ];

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: messages,
                    temperature: 0.3,
                    max_tokens: 1500
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('OpenAI API Error:', errorData);
                throw new Error(`OpenAI API í˜¸ì¶œ ì‹¤íŒ¨: ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            // Update conversation history
            conversationHistory.push({ role: 'user', content: message });
            conversationHistory.push({ role: 'assistant', content: aiResponse });

            // Keep only last 10 messages
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }

            return aiResponse;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
    </script>

    <!-- Help Button (Contact Info) -->
    <button class="help-button" id="helpButton" aria-label="ì—°ë½ì²˜ ë³´ê¸°">ë¬¸ì˜í•˜ê¸°</button>

    <div class="help-popup" id="helpPopup">
        <div class="help-popup-header">
            <div class="help-popup-icon">ì´</div>
            <div class="help-popup-title">
                <h3>ì´ìœ¤ì°½ íŠ¸ë ˆì´ë„ˆ</h3>
                <p>ë¬¸ì˜í•˜ê¸°</p>
            </div>
        </div>

        <div class="help-popup-content">
            <a href="tel:010-5253-0489" class="help-contact-item">
                <div class="help-contact-icon phone">ğŸ“</div>
                <div class="help-contact-info">
                    <div class="help-contact-label">Phone</div>
                    <div class="help-contact-value">010-5253-0489</div>
                </div>
            </a>

            <a href="https://www.instagram.com/tr_helper_lee?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" rel="noopener noreferrer" class="help-contact-item">
                <div class="help-contact-icon instagram">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                    </svg>
                </div>
                <div class="help-contact-info">
                    <div class="help-contact-label">Instagram</div>
                    <div class="help-contact-value">@tr_helper_lee</div>
                </div>
            </a>

            <a href="https://blog.naver.com/earnest0319" target="_blank" rel="noopener noreferrer" class="help-contact-item">
                <div class="help-contact-icon blog">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16.273 12.845L7.376 0H0v24h7.726V11.156L16.624 24H24V0h-7.727v12.845z"/>
                    </svg>
                </div>
                <div class="help-contact-info">
                    <div class="help-contact-label">Naver Blog</div>
                    <div class="help-contact-value">earnest0319</div>
                </div>
            </a>
        </div>

        <div class="help-popup-footer">
            ì–¸ì œë“ ì§€ í¸í•˜ê²Œ ì—°ë½ì£¼ì„¸ìš” ğŸ˜Š
        </div>
    </div>

    <script>
        // Help button toggle
        const helpButton = document.getElementById('helpButton');
        const helpPopup = document.getElementById('helpPopup');

        helpButton.addEventListener('click', (e) => {
            e.stopPropagation();
            helpPopup.classList.toggle('active');
        });

        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            if (!helpPopup.contains(e.target) && !helpButton.contains(e.target)) {
                helpPopup.classList.remove('active');
            }
        });

        // Prevent popup click from closing
        helpPopup.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    </script>
</body>
</html>
